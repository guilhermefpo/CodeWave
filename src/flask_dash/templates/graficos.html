{% extends "index.html" %}

{% block title %}<title>CodeWave: Gráficos</title>{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='graficos.css') }}">
{% endblock %}

{% block main %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Dashboard Demográfico de SJC</h1>
        <p>Explore dados demográficos e estatísticos de São José dos Campos através de visualizações interativas</p>
    </div>
    
    <!-- Painel de Filtros -->
    <div class="filters-card">
        <form method="POST" class="filter-form" id="form-graficos">
            <div class="filters-row">
                
                <!-- Seleção do Censo -->
                <div class="filter-group">
                    <label for="censo">Tipo de Censo:</label>
                    <select name="censo" id="censo" onchange="this.form.submit()">
                        <option value="Censo_d" {% if censo == 'Censo_d' %}selected{% endif %}>Censo Demográfico</option>
                        <option value="Censo_e" {% if censo == 'Censo_e' %}selected{% endif %}>Censo Escolar</option>
                    </select>
                </div>
                
                <!-- Filtros do Censo Demográfico -->
                <div class="conditional-filters" id="censo-d-filters" style="display: {% if censo == 'Censo_d' %}flex{% else %}none{% endif %};">
                    <div class="filter-group">
                        <label for="grafico">Tipo de Gráfico:</label>
                        <!-- Agora o 'selected' funcionará pois 'tipo' é enviado pelo app.py -->
                        <select name="grafico" id="grafico" onchange="this.form.submit()">
                            <option value="barras" {% if tipo == 'barras' %}selected{% endif %}>População por grupo Etário</option>
                            <option value="piramide" {% if tipo == 'piramide' %}selected{% endif %}>Pirâmide Etária</option>
                            <option value="setor" {% if tipo == 'setor' %}selected{% endif %}>População por Setor</option>
                            <option value="domici" {% if tipo == 'domici' %}selected{% endif %}>Domicílios por Região</option>
                            <option value="popu_regi" {% if tipo == 'popu_regi' %}selected{% endif %}>População por Região</option>
                        </select>
                    </div>
                </div>
                
                <!-- Filtros do Censo Escolar -->
                <div class="conditional-filters" id="censo-e-filters" style="display: {% if censo == 'Censo_e' %}flex{% else %}none{% endif %};">
                    <div class="filter-group">
                        <label for="regiao">Região:</label>
                        <select name="regiao" id="regiao" onchange="this.form.submit()">
                            <option value="NORTE" {% if regi == 'NORTE' %}selected{% endif %}>Norte</option>
                            <option value="SUL" {% if regi == 'SUL' %}selected{% endif %}>Sul</option>
                            <option value="LESTE" {% if regi == 'LESTE' %}selected{% endif %}>Leste</option>
                            <option value="SUDESTE" {% if regi == 'SUDESTE' %}selected{% endif %}>Sudeste</option>
                            <option value="OESTE" {% if regi == 'OESTE' %}selected{% endif %}>Oeste</option>
                            <option value="CENTRO" {% if regi == 'CENTRO' %}selected{% endif %}>Centro</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="escolas">Nível de Ensino:</label>
                        <select name="escolas" id="escolas" onchange="this.form.submit()">
                            {% for x, y in titulo.items() %}
                            <option value="{{ x }}" {% if esco == x %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
            </div>
        </form>
    </div>
    
    <!-- Tags de Filtros Ativos (Feedback Visual) -->
    {% if censo %}
    <div class="active-filters">
        <span class="active-filters-label">Visualizando:</span>
        {% if censo == 'Censo_d' %}
            <span class="filter-tag">Censo: Demográfico</span>
            
            <!-- Nomes amigáveis para o tipo de gráfico selecionado -->
            {% if tipo == 'barras' %}
                <span class="filter-tag" style="background-color: #e9f2ff; border: 1px solid #004997;">População por Etária</span>
            {% elif tipo == 'piramide' %}
                <span class="filter-tag" style="background-color: #e9f2ff; border: 1px solid #004997;">Pirâmide Etária</span>
            {% elif tipo == 'setor' %}
                <span class="filter-tag" style="background-color: #e9f2ff; border: 1px solid #004997;">População por Setor</span>
            {% elif tipo == 'domici' %}
                <span class="filter-tag" style="background-color: #e9f2ff; border: 1px solid #004997;">Domicílios por Região</span>
            {% elif tipo == 'popu_regi' %}
                <span class="filter-tag" style="background-color: #e9f2ff; border: 1px solid #004997;">População por Região</span>
            {% endif %}

        {% elif censo == 'Censo_e' %}
            <span class="filter-tag">Censo: Escolar</span>
            {% if regi %}
                <span class="filter-tag">Região: {{ regi|title }}</span>
            {% endif %}
            {% if esco and titulo[esco] %}
                <span class="filter-tag">Nível: {{ titulo[esco] }}</span>
            {% endif %}
        {% endif %}
    </div>
    {% endif %}
    
    <!-- 1. CARTÃO DO GRÁFICO -->
    <div class="main-chart-card">
        <div class="chart-header">
            <h3 class="chart-title">Gráfico Estatístico</h3>
        </div>
        <div class="chart-container-large">
            {% if grap %}
                <div class="graph-wrapper-large">{{ grap|safe }}</div>
            {% else %}
                <div class="no-chart-large">
                    <p>Carregando dados...</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 2. CARTÃO DO MAPA -->
    <div class="map-card-large" style="width: 90%; max-width: 1000px; margin: 0 auto;">
        <div class="chart-header">
            <h3 class="chart-title">Mapa Geográfico - SJC</h3>
        </div>
        
        <div class="map-container-large" style="height: 500px; overflow: hidden; border-radius: 8px;">
            {% if m %}
                {{ m|safe }}
            {% else %}
                <div class="no-map">
                    <p>Mapa indisponível.</p>
                </div>
            {% endif %}
        </div>
        
        <div class="legend" style="margin-top: 1.5rem; display: flex; flex-direction: row; flex-wrap: wrap; gap: 1.5rem; justify-content: center; padding-bottom: 1rem;">
            <div class="legend-item"><div class="legend-color" style="background-color: #004997;"></div><span>Oeste</span></div>
            <div class="legend-item"><div class="legend-color" style="background-color: #28a745;"></div><span>Norte</span></div>
            <div class="legend-item"><div class="legend-color" style="background-color: #6328a7;"></div><span>Sudeste</span></div>
            <div class="legend-item"><div class="legend-color" style="background-color: #fffb00;"></div><span>Sul</span></div>
            <div class="legend-item"><div class="legend-color" style="background-color: #ff0000;"></div><span>Leste</span></div>
            <div class="legend-item"><div class="legend-color" style="background-color: #c5511c;"></div><span>Centro</span></div>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const censoSelect = document.getElementById('censo');
    const censoDFilters = document.getElementById('censo-d-filters');
    const censoEFilters = document.getElementById('censo-e-filters');
    
    function updateFilterVisibility() {
        const selectedCenso = censoSelect.value;
        
        if (selectedCenso === 'Censo_d') {
            censoDFilters.style.display = 'flex';
            censoEFilters.style.display = 'none';
        } else {
            censoDFilters.style.display = 'none';
            censoEFilters.style.display = 'flex';
        }
    }
    
    censoSelect.addEventListener('change', updateFilterVisibility);
    updateFilterVisibility();
});
</script>
{% endblock %}